<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadow Clone - Mobile</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            color: #ddd;
            overflow: hidden;
            font-family: 'Courier Prime', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            width: 100%; 
            height: 100%;
            max-width: 800px;
            max-height: 450px;
            aspect-ratio: 16/9;
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- UI LAYER --- */
        #gameUI {
            position: absolute;
            top: 15px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
            opacity: 0; 
            transition: opacity 0.5s;
        }

        #gameUI.visible { opacity: 1; }

        h1 { font-size: 18px; margin: 0; text-shadow: 0 0 5px white; }
        p { font-size: 12px; color: #aaa; margin: 2px 0; }

        /* --- CONTROLS --- */
        .touch-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px 30px;
        }

        .d-pad, .action-pad {
            pointer-events: auto;
            display: flex;
            gap: 15px;
        }

        .touch-btn {
            width: 65px;
            height: 65px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            touch-action: none;
            transition: transform 0.1s, background 0.1s;
            cursor: pointer;
        }

        .touch-btn:active, .touch-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
            border-color: rgba(255, 255, 255, 0.8);
        }

        /* --- MENUS --- */
        #menuToggleBtn {
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 100;
            width: 45px;
            height: 45px;
            background: rgba(0,0,0,0.6);
            border: 1px solid #555;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 8px;
            pointer-events: auto;
        }

        .menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.92);
            backdrop-filter: blur(8px);
            z-index: 50;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .menu-screen.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .menu-title {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: 8px;
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            margin-bottom: 40px;
        }

        .btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #ddd;
            padding: 15px 0;
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            width: 240px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            position: relative;
            z-index: 60;
        }

        .btn:hover { background: rgba(255,255,255,0.1); }
        .btn:active { background: #fff; color: #000; transform: scale(0.98); }
        
        .btn.locked {
            opacity: 0.4;
            border-color: #444;
            color: #555;
            pointer-events: none;
        }

        /* --- SETTINGS & LEVELS --- */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 240px;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 4px; bottom: 4px;
            background-color: #aaa;
            transition: .4s;
        }
        
        input:checked + .slider { background-color: #ddd; }
        input:checked + .slider:before { transform: translateX(26px); background-color: #222; }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .level-btn {
            width: 70px;
            padding: 15px 0;
            margin: 0;
        }

        /* --- LOADING & ROTATE --- */
        #loadingScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: #000;
            color: #fff;
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            letter-spacing: 5px;
        }

        #rotateWarning {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: #111;
            color: #fff;
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        @media screen and (orientation: portrait) {
            #rotateWarning { display: flex; }
            #gameContainer { display: none; }
        }

        /* Overlay Effects */
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 5; opacity: 0.5;
        }
        
        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; z-index: 4;
        }

        /* Level Indicator Animation */
        #levelIndicator {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 50px;
            color: white;
            opacity: 0;
            pointer-events: none;
            z-index: 30;
            text-shadow: 0 0 20px white;
            letter-spacing: 5px;
            transition: opacity 1s;
        }
        
        #winButtons { display: none; margin-top: 20px; }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loadingScreen">LOADING...</div>

    <!-- ROTATE WARNING -->
    <div id="rotateWarning">
        <div class="rotate-icon">üì±</div>
        <h2>ROTATE DEVICE</h2>
        <p>Landscape mode required</p>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="450"></canvas>
        <div class="vignette"></div>
        <div class="scanlines"></div>
        
        <div id="levelIndicator">LEVEL 1</div>

        <!-- TOP MENU BUTTON -->
        <div id="menuToggleBtn">‚ò∞</div>

        <!-- IN-GAME UI -->
        <div id="gameUI">
            <h1 id="levelText">LEVEL 1</h1>
            <p id="cloneText">CLONES: 0</p>
            <p id="collisionText" style="color:#888">COLLISION: OFF</p>
        </div>

        <!-- TOUCH CONTROLS -->
        <div class="touch-controls">
            <div class="d-pad">
                <div class="touch-btn" id="btnLeft">‚Üê</div>
                <div class="touch-btn" id="btnRight">‚Üí</div>
                <div class="touch-btn" id="btnJump" style="margin-left: 20px;">‚Üë</div>
            </div>
            <div class="action-pad">
                <div class="touch-btn" id="btnCollision" style="font-size: 16px;">COL</div>
                <div class="touch-btn" id="btnRewind" style="color: #ff9999;">R</div>
            </div>
        </div>

        <!-- MAIN MENU -->
        <div id="mainMenu" class="menu-screen active">
            <div class="menu-title">PARADOX</div>
            <button id="btnPlayMain" class="btn">PLAY</button>
            <button id="btnLevelsMain" class="btn">LEVELS</button>
            <button id="btnSettingsMain" class="btn">SETTINGS</button>
        </div>

        <!-- PAUSE MENU -->
        <div id="ingameMenu" class="menu-screen">
            <div class="menu-title">PAUSED</div>
            <button id="btnResume" class="btn">RESUME</button>
            <button id="btnRestart" class="btn">RESTART</button>
            <button id="btnSettingsPause" class="btn">SETTINGS</button>
            <button id="btnExit" class="btn">MAIN MENU</button>
        </div>

        <!-- LEVELS MENU -->
        <div id="levelsMenu" class="menu-screen">
            <h2 style="color:white; margin-bottom:30px; letter-spacing:3px;">SELECT LEVEL</h2>
            <div class="level-grid">
                <button id="lvlBtn0" class="btn level-btn">1</button>
                <button id="lvlBtn1" class="btn level-btn locked">2</button>
                <button id="lvlBtn2" class="btn level-btn locked">3</button>
            </div>
            <button id="btnBackLevels" class="btn" style="margin-top:30px;">BACK</button>
        </div>

        <!-- SETTINGS MENU -->
        <div id="settingsMenu" class="menu-screen">
            <div class="menu-title">SETTINGS</div>
            <div class="setting-row">
                <span>SOUND</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="soundToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <button id="btnCloseSettings" class="btn" style="margin-top: 30px;">CLOSE</button>
        </div>

        <!-- WIN SCREEN -->
        <div id="winScreen" class="menu-screen">
            <h1 id="winTitle" style="font-size: 32px; color:white; margin-bottom: 20px;">COMPLETED</h1>
            <p id="winMessage" style="color:#ccc; margin-bottom: 30px;">Timeline restored.</p>
            <div id="winButtons">
                <button id="btnWinMain" class="btn">MAIN MENU</button>
            </div>
        </div>
    </div>

    <script>
        // --- SECURE INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Bind all events safely after DOM loads
            bindEvents();
            
            // Telegram Init
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                try { tg.expand(); } catch(e){}
            }

            // Force hide loading after 1.5s
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
            }, 1000);

            // Start Game Loop
            loadLevel(0);
            gameState = 'MENU';
            loop();
        });

        function bindEvents() {
            // Main Menu
            document.getElementById('btnPlayMain').addEventListener('click', startGame);
            document.getElementById('btnLevelsMain').addEventListener('click', openLevels);
            document.getElementById('btnSettingsMain').addEventListener('click', openSettings);

            // Pause Menu
            document.getElementById('menuToggleBtn').addEventListener('click', toggleIngameMenu);
            document.getElementById('btnResume').addEventListener('click', resumeGame);
            document.getElementById('btnRestart').addEventListener('click', restartLevel);
            document.getElementById('btnSettingsPause').addEventListener('click', openSettings);
            document.getElementById('btnExit').addEventListener('click', goToMainMenu);

            // Levels & Settings
            document.getElementById('btnBackLevels').addEventListener('click', closeLevels);
            document.getElementById('btnCloseSettings').addEventListener('click', closeSettings);
            document.getElementById('soundToggle').addEventListener('change', (e) => toggleSound(e.target.checked));

            // Level Selection
            document.getElementById('lvlBtn0').addEventListener('click', () => selectLevel(0));
            document.getElementById('lvlBtn1').addEventListener('click', () => selectLevel(1));
            document.getElementById('lvlBtn2').addEventListener('click', () => selectLevel(2));

            // Win Screen
            document.getElementById('btnWinMain').addEventListener('click', goToMainMenu);

            // Touch Controls (Visual Feedback + Logic)
            bindTouchControl('btnLeft', 'left');
            bindTouchControl('btnRight', 'right');
            bindTouchControl('btnJump', 'jump');
            
            // Actions
            const btnRewind = document.getElementById('btnRewind');
            btnRewind.addEventListener('touchstart', (e) => { e.preventDefault(); createCloneAndReset(); btnRewind.classList.add('active'); });
            btnRewind.addEventListener('touchend', (e) => { e.preventDefault(); btnRewind.classList.remove('active'); });
            // Mouse fallback for PC testing
            btnRewind.addEventListener('mousedown', () => createCloneAndReset());

            const btnCollision = document.getElementById('btnCollision');
            btnCollision.addEventListener('touchstart', (e) => { e.preventDefault(); toggleCollision(); btnCollision.classList.add('active'); });
            btnCollision.addEventListener('touchend', (e) => { e.preventDefault(); btnCollision.classList.remove('active'); });
            btnCollision.addEventListener('mousedown', () => toggleCollision());
        }

        function bindTouchControl(id, key) {
            const btn = document.getElementById(id);
            btn.addEventListener('touchstart', (e) => { 
                e.preventDefault(); 
                touchKeys[key] = true; 
                btn.classList.add('active'); 
            });
            btn.addEventListener('touchend', (e) => { 
                e.preventDefault(); 
                touchKeys[key] = false; 
                btn.classList.remove('active'); 
            });
            // Fallback for mouse on PC
            btn.addEventListener('mousedown', () => { touchKeys[key] = true; btn.classList.add('active'); });
            btn.addEventListener('mouseup', () => { touchKeys[key] = false; btn.classList.remove('active'); });
            btn.addEventListener('mouseleave', () => { touchKeys[key] = false; btn.classList.remove('active'); });
        }

        // --- GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const mainMenu = document.getElementById('mainMenu');
        const ingameMenu = document.getElementById('ingameMenu');
        const levelsMenu = document.getElementById('levelsMenu');
        const settingsMenu = document.getElementById('settingsMenu');
        const winScreen = document.getElementById('winScreen');
        const winButtons = document.getElementById('winButtons'); // Fixed: Added missing definition
        const gameUI = document.getElementById('gameUI');
        const levelTextUI = document.getElementById('levelText');
        const cloneTextUI = document.getElementById('cloneText');
        const collisionTextUI = document.getElementById('collisionText');
        const levelIndicator = document.getElementById('levelIndicator');

        // Constants
        const GRAVITY = 0.6;
        const FRICTION = 0.8;
        const SPEED = 3; 
        const JUMP_FORCE = 12;

        // State
        let gameState = 'MENU';
        let currentLevelIndex = 0;
        let unlockedLevels = 1;
        let frameCount = 0;
        let gameOver = false;
        let keys = {};
        let touchKeys = { left: false, right: false, jump: false };
        let cloneCollisionEnabled = false;
        let soundEnabled = true;

        // Entities
        let player, clones = [], platforms = [], buttons = [], doors = [], particles = [], goal = null;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!soundEnabled || audioCtx.state === 'suspended') { if(type==='click') audioCtx.resume(); else return; }
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;
                
                if (type === 'jump') {
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'button') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'click') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.02, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                } else if (type === 'win') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(400, now);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.5);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 1.5);
                    osc.start(now); osc.stop(now + 1.5);
                }
            } catch(e){}
        }

        // --- LEVELS ---
        const LEVELS = [
            { // Level 1
                start: {x: 50, y: 350}, goal: {x: 720, y: 340},
                platforms: [
                    {x:0, y:400, w:800, h:50}, {x:0, y:0, w:20, h:450}, 
                    {x:200, y:320, w:100, h:20}, {x:500, y:250, w:300, h:20}, {x:780, y:0, w:20, h:450}
                ],
                doors: [{x:600, y:250, h:150, id:1}],
                buttons: [{x:240, y:320, target:1}]
            },
            { // Level 2
                start: {x: 50, y: 350}, goal: {x: 720, y: 130},
                platforms: [
                    {x:0, y:400, w:800, h:50}, {x:0, y:0, w:800, h:20}, {x:0, y:0, w:20, h:450}, {x:780, y:0, w:20, h:450},
                    {x:160, y:290, w:80, h:20}, {x:20, y:200, w:140, h:20}, 
                    {x:300, y:250, w:20, h:150}, {x:450, y:320, w:100, h:20}, {x:600, y:200, w:180, h:20}
                ],
                doors: [{x:620, y:20, h:180, id:1}, {x:680, y:20, h:180, id:2}],
                buttons: [{x:50, y:200, target:1}, {x:500, y:320, target:2}]
            },
            { // Level 3
                start: {x: 50, y: 350}, goal: {x: 720, y: 340},
                platforms: [
                    {x:0, y:400, w:800, h:50}, {x:0, y:0, w:20, h:450}, {x:780, y:0, w:20, h:450},
                    {x:250, y:0, w:20, h:250}, {x:350, y:300, w:150, h:20}, {x:600, y:0, w:20, h:250}
                ],
                doors: [{x:250, y:250, h:150, id:1}, {x:600, y:250, h:150, id:2}],
                buttons: [{x:100, y:400, target:1}, {x:400, y:300, target:2}]
            }
        ];

        // --- MENU ACTIONS ---
        function toggleIngameMenu() {
            playSound('click');
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                ingameMenu.classList.add('active');
            } else if (gameState === 'PAUSED') {
                resumeGame();
            }
        }

        function resumeGame() {
            playSound('click');
            gameState = 'PLAYING';
            ingameMenu.classList.remove('active');
        }

        function goToMainMenu() {
            playSound('click');
            gameState = 'MENU';
            mainMenu.classList.add('active');
            ingameMenu.classList.remove('active');
            levelsMenu.classList.remove('active');
            settingsMenu.classList.remove('active');
            winScreen.classList.remove('active');
            gameUI.classList.remove('visible');
        }

        function restartLevel() {
            playSound('click');
            resetLevel(true);
            resumeGame();
        }

        function startGame() {
            playSound('click');
            loadLevel(currentLevelIndex);
            gameState = 'PLAYING';
            mainMenu.classList.remove('active');
            gameUI.classList.add('visible');
            winScreen.classList.remove('active');
        }

        function openLevels() {
            playSound('click');
            updateLevelButtons();
            levelsMenu.classList.add('active');
            if(gameState === 'MENU') mainMenu.classList.remove('active');
            if(gameState === 'PAUSED') ingameMenu.classList.remove('active');
        }

        function closeLevels() {
            playSound('click');
            levelsMenu.classList.remove('active');
            if(gameState === 'MENU') mainMenu.classList.add('active');
            else if(gameState === 'PAUSED') ingameMenu.classList.add('active');
        }

        function openSettings() {
            playSound('click');
            document.getElementById('soundToggle').checked = soundEnabled;
            settingsMenu.classList.add('active');
            if(gameState === 'MENU') mainMenu.classList.remove('active');
            if(gameState === 'PAUSED') ingameMenu.classList.remove('active');
        }

        function closeSettings() {
            playSound('click');
            settingsMenu.classList.remove('active');
            if(gameState === 'MENU') mainMenu.classList.add('active');
            else if(gameState === 'PAUSED') ingameMenu.classList.add('active');
        }

        function updateLevelButtons() {
            for (let i = 0; i < LEVELS.length; i++) {
                const btn = document.getElementById(`lvlBtn${i}`);
                if(btn) {
                    if (i < unlockedLevels) btn.classList.remove('locked');
                    else btn.classList.add('locked');
                }
            }
        }

        function selectLevel(index) {
            if (index >= unlockedLevels) return;
            playSound('click');
            currentLevelIndex = index;
            levelsMenu.classList.remove('active');
            startGame();
        }

        function toggleSound(enabled) {
            soundEnabled = enabled;
            playSound('click');
        }

        function toggleCollision() {
            playSound('click');
            cloneCollisionEnabled = !cloneCollisionEnabled;
            collisionTextUI.innerText = `COLLISION: ${cloneCollisionEnabled ? 'ON' : 'OFF'}`;
            collisionTextUI.style.color = cloneCollisionEnabled ? '#4f4' : '#888';
            document.getElementById('btnCollision').style.background = cloneCollisionEnabled ? 'rgba(100, 255, 100, 0.3)' : '';
        }

        // --- GAME LOGIC ---
        function loadLevel(index) {
            if (index >= LEVELS.length) { gameComplete(); return; }
            const ld = LEVELS[index];
            platforms=[]; doors=[]; buttons=[]; clones=[]; particles=[];
            frameCount=0; gameOver=false;
            ld.platforms.forEach(p => platforms.push(new GameObject(p.x, p.y, p.w, p.h)));
            ld.doors.forEach(d => doors.push(new Door(d.x, d.y, d.h, d.id)));
            ld.buttons.forEach(b => buttons.push(new Button(b.x, b.y, b.target)));
            goal = ld.goal ? new Goal(ld.goal.x, ld.goal.y) : null;
            player = new Player(ld.start.x, ld.start.y);
            
            levelTextUI.innerText = `LEVEL ${index + 1}`;
            cloneTextUI.innerText = `CLONES: 0`;
            levelIndicator.innerText = `LEVEL ${index + 1}`;
            levelIndicator.style.opacity = 1;
            setTimeout(() => { levelIndicator.style.opacity = 0; }, 2000);
        }

        function createCloneAndReset() {
            if (gameOver || gameState !== 'PLAYING') return;
            if (player.history.length > 0) {
                playSound('rewind');
                clones.push(new Player(LEVELS[currentLevelIndex].start.x, LEVELS[currentLevelIndex].start.y, true, [...player.history]));
                cloneTextUI.innerText = `CLONES: ${clones.length}`;
            }
            player = new Player(LEVELS[currentLevelIndex].start.x, LEVELS[currentLevelIndex].start.y);
            frameCount = 0;
            clones.forEach(c => c.isExpired = false);
            for(let i=0; i<20; i++) particles.push(new Particle(50 + Math.random()*20, 350 + Math.random()*40));
        }

        function resetLevel(full) {
            if(full) { playSound('click'); loadLevel(currentLevelIndex); }
            else {
                player = new Player(LEVELS[currentLevelIndex].start.x, LEVELS[currentLevelIndex].start.y);
                frameCount = 0;
                clones.forEach(c => c.isExpired = false);
            }
        }

        function checkRectCollision(r1, r2) {
            return (r1.x < r2.x + r2.width && r1.x + r1.width > r2.x && r1.y < r2.y + r2.height && r1.y + r1.height > r2.y);
        }

        function update() {
            if (gameState !== 'PLAYING' || gameOver) return;
            
            particles.forEach((p,i) => { p.update(); if(p.life<=0) particles.splice(i,1); });
            
            const input = {
                left: keys['ArrowLeft'] || keys['KeyA'] || touchKeys.left,
                right: keys['ArrowRight'] || keys['KeyD'] || touchKeys.right,
                jump: keys['ArrowUp'] || keys['KeyW'] || keys['Space'] || touchKeys.jump
            };

            clones.forEach(c => c.update(null, platforms, doors, frameCount));
            player.update(input, platforms, doors, frameCount);

            const entities = [player, ...clones];
            buttons.forEach(b => b.update(entities));
            doors.forEach(d => d.update(buttons));
            frameCount++;
        }

        function draw() {
            ctx.fillStyle = '#111'; ctx.fillRect(0, 0, 800, 450);
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(100, 100, 50, 300); ctx.fillRect(600, 50, 80, 400); // Decor
            platforms.forEach(p => p.draw(ctx));
            buttons.forEach(b => b.draw(ctx));
            doors.forEach(d => d.draw(ctx));
            if (goal) goal.draw(ctx);
            clones.forEach(c => c.draw(ctx));
            if (player) player.draw(ctx);
            particles.forEach(p => p.draw(ctx));
        }

        function loop() {
            update(); draw(); requestAnimationFrame(loop);
        }

        window.addEventListener('keydown', (e) => {
            if (gameState === 'PLAYING') {
                keys[e.key] = true; keys[e.code] = true;
                if (e.key.toLowerCase() === 'r') createCloneAndReset();
                if (e.key === 'Escape') toggleIngameMenu();
                if (e.key.toLowerCase() === 'c') toggleCollision();
            }
        });
        window.addEventListener('keyup', (e) => { keys[e.key] = false; keys[e.code] = false; });

        // --- CLASSES (Minimal) ---
        class GameObject {
            constructor(x, y, w, h, c='black') { this.x=x; this.y=y; this.width=w; this.height=h; this.color=c; }
            draw(ctx) { ctx.fillStyle=this.color; ctx.fillRect(this.x,this.y,this.width,this.height); }
        }
        class Goal extends GameObject {
            constructor(x, y) { super(x, y, 40, 60, '#fff'); }
            draw(ctx) { ctx.fillStyle='#fff'; ctx.shadowBlur=20; ctx.shadowColor='#fff'; ctx.fillRect(this.x,this.y,this.width,this.height); ctx.shadowBlur=0; }
        }
        class Button extends GameObject {
            constructor(x, y, t) { super(x, y-10, 40, 10, '#333'); this.oy=y-10; this.py=y-4; this.targetDoorId=t; this.isPressed=false; }
            update(ents) {
                let p = false;
                ents.forEach(e => { if(!e.isExpired && e.x < this.x+this.width && e.x+e.width > this.x && e.y+e.height >= this.y && e.y < this.y+this.height+5) p=true; });
                if(p && !this.isPressed) playSound('button');
                this.isPressed = p; this.y = p ? this.py : this.oy; this.height = p ? 4 : 10;
            }
            draw(ctx) { ctx.fillStyle='#222'; ctx.fillRect(this.x-5,this.oy+5,this.width+10,5); ctx.fillStyle=this.isPressed?'#fff':'#666'; ctx.shadowBlur=this.isPressed?10:0; ctx.shadowColor="white"; ctx.fillRect(this.x,this.y,this.width,this.height); ctx.shadowBlur=0; }
        }
        class Door extends GameObject {
            constructor(x, y, h, id) { super(x, y, 20, h, 'black'); this.id=id; this.oh=0; this.th=h; }
            update(btns) {
                let a = false; btns.forEach(b => { if(b.targetDoorId===this.id && b.isPressed) a=true; });
                if(a && this.oh < this.th) this.oh+=2; else if(!a && this.oh > 0) this.oh-=8;
            }
            getCurrentHeight() { return this.th - this.oh; }
            draw(ctx) { ctx.strokeStyle='#444'; ctx.lineWidth=2; ctx.strokeRect(this.x,this.y,this.width,this.th); ctx.fillStyle='#000'; ctx.fillRect(this.x,this.y,this.width,this.getCurrentHeight()); }
        }
        class Particle {
            constructor(x,y) { this.x=x; this.y=y; this.vx=(Math.random()-0.5)*2; this.vy=(Math.random()-0.5)*2; this.life=1; this.size=Math.random()*2+1; }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.02; }
            draw(ctx) { ctx.fillStyle=`rgba(255,255,255,${this.life*0.5})`; ctx.fillRect(this.x,this.y,this.size,this.size); }
        }
        class Player {
            constructor(x,y,isC=false,rec=[]) { this.x=x; this.y=y; this.width=15; this.height=35; this.vx=0; this.vy=0; this.isGrounded=false; this.isClone=isC; this.history=rec; this.isExpired=false; this.wjp=false; }
            update(inp,plats,doors,frame) {
                if(this.isClone) {
                    if(frame===0) this.isExpired=false;
                    if(this.isExpired) return;
                    if(frame<this.history.length) {
                        let st=this.history[frame];
                        let tr={x:st.x, y:st.y, width:15, height:35};
                        let block=false;
                        doors.forEach(d => { if(d.getCurrentHeight()>5 && checkRectCollision(tr, {x:d.x, y:d.y, width:d.width, height:d.getCurrentHeight()})) block=true; });
                        if(!block) { this.x=st.x; this.y=st.y; }
                    } else { if(!this.isExpired) { this.isExpired=true; for(let i=0;i<10;i++) particles.push(new Particle(this.x,this.y)); } }
                } else {
                    if(inp.left) this.vx-=1; else if(inp.right) this.vx+=1; else this.vx*=FRICTION;
                    if(this.vx>SPEED) this.vx=SPEED; if(this.vx<-SPEED) this.vx=-SPEED;
                    this.vy+=GRAVITY;
                    if(inp.jump && !this.wjp && this.isGrounded) { this.vy=-JUMP_FORCE; this.isGrounded=false; playSound('jump'); }
                    this.wjp=inp.jump;
                    this.x+=this.vx; this.y+=this.vy; this.isGrounded=false;
                    
                    let obs=[...platforms];
                    doors.forEach(d=>{ if(d.getCurrentHeight()>5) obs.push({x:d.x, y:d.y, width:d.width, height:d.getCurrentHeight()}); });
                    if(cloneCollisionEnabled) clones.forEach(c=>{ if(!c.isExpired) obs.push(c); });

                    obs.forEach(p => {
                        if(checkRectCollision(this, p)) {
                            let pb = this.y+this.height-this.vy;
                            if(pb<=p.y+10 && this.vy>=0) { this.y=p.y-this.height; this.vy=0; this.isGrounded=true; }
                            else if(this.y-this.vy>=p.y+p.height) { this.y=p.y+p.height; this.vy=0; }
                            else { if(this.vx>0) this.x=p.x-this.width; else this.x=p.x+p.width; this.vx=0; }
                        }
                    });
                    if(this.x<0) this.x=0; if(this.x>800) this.x=800-this.width;
                    if(goal && checkRectCollision(this, goal)) { 
                        gameOver=true; playSound('win');
                        if(currentLevelIndex+1>=unlockedLevels) unlockedLevels=currentLevelIndex+2;
                        if(currentLevelIndex+1>=LEVELS.length) {
                            document.getElementById('winTitle').innerText="GAME OVER";
                            document.getElementById('winMessage').innerText="All Paradoxes Solved!";
                            winButtons.style.display='block';
                        } else {
                            document.getElementById('winTitle').innerText="LEVEL COMPLETED";
                            document.getElementById('winMessage').innerText="Next Paradox...";
                            winButtons.style.display='none';
                            setTimeout(()=>{ winScreen.classList.remove('active'); currentLevelIndex++; loadLevel(currentLevelIndex); }, 2000);
                        }
                        winScreen.classList.add('active');
                    }
                    if(this.y>450) resetLevel(false);
                    this.history.push({x:this.x, y:this.y});
                }
            }
            draw(ctx) {
                if(this.isClone && this.isExpired) return;
                ctx.save();
                if(this.isClone) { ctx.fillStyle='rgba(200,200,255,0.3)'; if(cloneCollisionEnabled) ctx.strokeStyle='white', ctx.strokeRect(this.x,this.y,this.width,this.height); }
                else ctx.fillStyle='white';
                ctx.shadowBlur=10; ctx.shadowColor='white';
                ctx.fillRect(this.x,this.y,this.width,this.height);
                if(!this.isClone) { ctx.fillStyle='black'; ctx.fillRect(this.vx>=0?this.x+8:this.x+3, this.y+5, 4,4); }
                ctx.restore();
            }
        }
    </script>
</body>
</html>